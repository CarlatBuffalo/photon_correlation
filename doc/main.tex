\documentclass{book}

\usepackage[squaren]{SIunits}

\title{Picoquant: Tools for reading and analyzing Picoquant data files}
\author{Thomas Bischof \\ \texttt{tbischof@mit.edu}}
\date{\today}

\newcommand{\cps}{cps}
\newcommand{\braces}[1]{\ensuremath{\left\lbrace #1 \right\rbrace}}
\newcommand{\angles}[1]{\ensuremath{\left\langle #1 \right\rangle}}
\newcommand{\stdin}{\texttt{stdin}}
\newcommand{\stdout}{\texttt{stdout}}

\begin{document}

\maketitle
\tableofcontents
 
\chapter{Introduction}
\section{The layout of this document}
This documents is laid out in roughly three parts:
\begin{enumerate}
\item Overview of terminology and methods
\item Documentation for each program
\item Applications of the software to real problems
\end{enumerate}
In the chapters devoted to the various programs, the documentation is divided further:
\begin{enumerate}
\item Command-line syntax
\item Theoretical overview of the purpose of the program
\item Details of the implementation
\end{enumerate}

\section{A (very) brief overview of the science and technology}
In single-molecule spectroscopy, single-photon detectors are often used to perform time-resolved experiments. Detectors such as silicon-based avalanche photodiodes (APDs) can be used to detect the arrival time a photon with better than 1\nano\second{} resolution, and can detect up to $10^{7}$ photons per second before saturation, abbreviated as 10\mega\cps{} hereafter (counts per second). Hardware capable of resolving these arrival times is of great use for revealing time-dependent structure to the photon stream, such as intensity fluctuations and bunching, so various hardware designs have been developed to permit such measurements.

One line of instruments is the timing hardware produced by Picoquant GmBH, such as the Timeharp, Picoharp, and Hydraharp. These modules are capable of detecting pulse arrivals on multiple input channels with a resolution of as little as 1\pico\second, and operate in a few distinct modes:
\begin{enumerate}
\item Interactive (histogram): one input channel is designated as a sync source, representing a clock-starting signal. On the other channels, pulse arrival times are recorded relative to this clock source, and the times binned into a histogram. 
\item Time-tagged time-resolved (TTTR): 
	\begin{enumerate}
	\item T2: all channels are treated equally, and all pulse arrival times relative to the start of the experiment are recorded. 
	\item T3: this is similar to histogram mode, but instead of binning the arrival times, the sync event number and relative arrival time are both recorded.
	\end{enumerate}
\end{enumerate}

In all cases, the times are discrete and represent some number of cycles of a clock, so all times must be treated as integers representing some number of picoseconds. This has important effects on the definition of time bins for histograms, and where appropriate some time will be devoted to discussing these factors. 

Considering these distinct modes, it is important to spend some time discussing their uses, and how their data should be handled.

\section{Data collection modes}
\subsection{Interactive (histogram)}
A common experiment for studying fluorophores is to measure the time-dependence of their response to an excitation. For example, a pulsed laser with pulse width significantly shorter than the relaxation times of interest can be used to excite a sample, and the resulting fluorescence detected by an APD. Because single-photon detectors are limited to detection of a single photon at once, to rebuild the decay curve it is necessary to average the result over many pulses of the laser, binning the relative arrival times to build a histogram of arrival times representing the time-averaged response of the system under study. If this time-averaged behavior is sufficient, then the interactive histogram mode is used to perform all of this collection and binning on the hardware without any post-processing. 

Consequently, interactive data consists of $N$ arrival time bins with boundaries $(t_{j}, t_{j+1})$ and the number of counts $n_{j}$ associated with that bin, so the data can be represented by the set:
\begin{equation}
\braces{((t_{j}, t_{j+1}), n_{j})}
\end{equation}
The exact choice of where the boundaries lie has some effect on the resulting histogram, but this performed in the hardware and presumably represents $t\in[t_{j}, t_{j+1})$. This choice is not detailed in the manuals for the hardware, but it is of little practical importance; typical detectors have two orders of magnitude more timing jitter than the timing hardware, so the exact definition of the histogram bin has a negligible effect.

\subsection{T2}
In T2 mode, all input channels are connected to photon detectors. At the start of the experiment, an internal clock is reset and started, providing a master timing reference. As a pulse arrives, the machine emits data encoding the channel and time of arrival, so the data follow the form:
\begin{equation}
\braces{(c_{j}, t_{j})}
\end{equation}
for a channel $c_{j}$ and arrival time $t_{j}$ of the $j$th photon. Typically, these data are used to examine time-dependent behavior, such as intensity fluctuations, particularly when the excitation source is continuous-wave. These data are also useful for calculation of correlation functions such as:
\begin{equation}
g^{(n)}(t_{2}, \ldots t_{n}) = \frac
	{\angles{I_{1}(t)\prod_{j=2}^{n}{I_{j}(t+t_{j})}}}
	{I_{1}(t)\prod_{j=2}^{n}{I_{j}(t+t_{j})}}
\end{equation}
The details of this calculation will laid out later, but one use of the $g^{(2)}(t)$ is to determine the number of emitters present in a signal. For example, a single emitter emitting one photon at any time will exhibit so-called antibunching behavior, where $g^{(2)}(t)\rightarrow 0$ for $t\approx 0$, indicating a diminished probability of seeing two successive photon emissions ($g^{(n)}(\braces{t_{j}})=1$ indicates no correlation). Correlations of higher order ($n\ge 3$) have their own uses, but quickly become computationally expensive for reasons which will become clear later.

\subsection{T3}
T3 mode is closest in character to the interactive mode, except that, instead of binning the photon arrival times on the hardware, the arrivals are recorded directly for later examination, as in T2 mode. This gives a data set of the form:
\begin{equation}
\braces{(c_{j}, p_{j}, t_{j})}
\end{equation}
for channel $c_{j}$, sync pulse number $p_{j}$, and relative arrival time $t_{j}$. Indeed, by defining bins and histogramming the $t_{j}$, the result from the interactive mode can be reproduced exactly. However, this mode also allows for studying time dependence and correlation in the data, as with T2 mode. In principle, any data collected in T3 mode can be transformed into T2 mode data if the sync source is regular, as the pulse number will represent some amount of time in the experiment, but there are subtle hardware and numerical issues (discussed later) which limit the practicality of this transformation.

Uses of this mode include the study of the time-dependent fluoresence lifetime of single molecules, which can switch between distinct states under various conditions. Correlation methods can also reveal important behavior, but again this will be discussed later.

\section{General design principles}
Analysis of these timing data can be roughly described as follows:
\begin{enumerate}
\item Produce a stream of photon events
\item Condition the stream by correlation, removal of extraneous information, homogenizing the detection channels, etc.
\item Collect the result to form some histogram of events.
\end{enumerate}
As such, these three phases are handled by distinct programs, which act as filters of a data stream by reading in values and outputting the appropriate new values. These streams are ultimately streams of binary data, but for any program the stream may be defined by some standard data stream (\stdin, \stdout) or by some file containing that data. 

For time-tagged modes, times are represented as integer multiples of 1\pico\second, although only the initial data streamer is actually aware of units; the conditioning and collection routines operate on time as an integer, without regard for its units.

All programs are designed to operate on a data stream until that stream terminates, so any division of a data stream should be handled by a separate program and the result fed into a distinct instance of the handler. 

The software is written in the C programming language, using the C99 standard. Where necessary, the definitions of data types have been defined to be of fixed width, but otherwise the definitions are those minimal for handling reasonable values. For example, in T2 mode time is defined as a signed 64-bit integer, representing $\approx 10^{19}\pico\second$, or $10^{7}\second$, or $106$ days. Pulses are counted as signed 64-bit integers, limiting their total to several thousand years of $10MHz$ pulsed laser excitation. With luck, your experiments will not exceed these values. 

\include{picoquant.tex}
\include{intensity.tex}
\include{correlate.tex}
\include{histogram.tex}
\include{applications.tex}
\end{document}
